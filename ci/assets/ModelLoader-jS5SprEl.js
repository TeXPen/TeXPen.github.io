const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CMiUM5kp.js","./index-Dibj986Z.css"])))=>i.map(i=>d[i]);
import{_ as D,a as S,M as w}from"./index-CMiUM5kp.js";import{getSessionOptions as F}from"./index-CBPy_vyv.js";class g{constructor(){}static getInstance(){return g.instance||(g.instance=new g),g.instance}async preDownloadModels(m,i,l){const{downloadManager:d}=await D(async()=>{const{downloadManager:t}=await import("./index-CMiUM5kp.js").then(s=>s.D);return{downloadManager:t}},__vite__mapDeps([0,1]),import.meta.url),r=[`onnx/${i.encoder_model_file_name}`,`onnx/${i.decoder_model_file_name}`],n={};r.forEach(t=>{n[t]={loaded:0,total:0}});const o=t=>(t/1024/1024).toFixed(2),u=()=>{if(!l)return;let t=0,s=0;const c=[];if(Object.entries(n).forEach(([_,a])=>{t+=a.loaded,s+=a.total;const e=_.includes("encoder")?"Enc":_.includes("decoder")?"Dec":"File",h=o(a.loaded),M=o(a.total);if(a.total>0){const $=Math.round(a.loaded/a.total*100);c.push(`${e}: ${h}/${M} MB (${$}%)`)}else c.push(`${e}: ${h} MB`)}),s===0)return;const f=Math.round(t/s*100);l(`${c.join(" | ")}`,f)};l&&l("Loading models...",0);const p=async t=>{const s=`https://huggingface.co/${m}/resolve/main/${t}`;await d.downloadFile(s,c=>{n[t]={loaded:c.loaded,total:c.total},u()})};await Promise.all(r.map(t=>p(t)))}async loadModelWithFallback(m,i,l){var n,o,u,p,t,s,c,f,_;const d=i,r=F(d);try{return{model:await S.from_pretrained(m,r),device:d}}catch(a){const e=a,h=((n=e==null?void 0:e.message)==null?void 0:n.includes("createBuffer"))||((o=e==null?void 0:e.message)==null?void 0:o.includes("mappedAtCreation"))||((u=e==null?void 0:e.message)==null?void 0:u.includes("too large for the implementation"))||((p=e==null?void 0:e.message)==null?void 0:p.includes("GPUDevice")),M=(t=e==null?void 0:e.message)==null?void 0:t.includes("Unsupported device"),$=((s=e==null?void 0:e.message)==null?void 0:s.includes("Failed to create the session"))||((c=e==null?void 0:e.message)==null?void 0:c.includes("Validation Error"))||((f=e==null?void 0:e.message)==null?void 0:f.includes("context"))||((_=e==null?void 0:e.message)==null?void 0:_.includes("adapter"));if((h||M||$)&&d===w.PROVIDERS.WEBGPU){console.warn("[ModelLoader] WebGPU error encountered, falling back to WASM:",e.message);const v=F(w.PROVIDERS.WASM);return{model:await S.from_pretrained(m,v),device:w.PROVIDERS.WASM}}else throw e}}async validateModelFiles(m,i){const{downloadManager:l}=await D(async()=>{const{downloadManager:n}=await import("./index-CMiUM5kp.js").then(o=>o.D);return{downloadManager:n}},__vite__mapDeps([0,1]),import.meta.url),d=[`onnx/${i.encoder_model_file_name}`,`onnx/${i.decoder_model_file_name}`],r=[];for(const n of d){const o=`https://huggingface.co/${m}/resolve/main/${n}`,u=n.split("/").pop(),p=w.CHECKSUMS[u];try{const t=await l.checkCacheIntegrity(o,p);t.ok||(console.warn(`[ModelLoader] File ${t.missing?"missing":"corrupted"}: ${n}${t.reason?` - ${t.reason}`:""}`),r.push(o))}catch(t){console.error(`[ModelLoader] Failed to check integrity for ${n}:`,t)}}return r}}const x=g.getInstance();export{g as ModelLoader,x as modelLoader};
