import{_ as S,g as F,M as $}from"./InferenceWorker-_gtIofs1.js";class g{constructor(){}static getInstance(){return g.instance||(g.instance=new g),g.instance}async preDownloadModels(r,i,l){const{downloadManager:d}=await import("./DownloadManager-CzsYuBUX.js"),m=[`onnx/${i.encoder_model_file_name}`,`onnx/${i.decoder_model_file_name}`],n={};m.forEach(t=>{n[t]={loaded:0,total:0}});const c=t=>(t/1024/1024).toFixed(2),u=()=>{if(!l)return;let t=0,a=0;const s=[];if(Object.entries(n).forEach(([f,o])=>{t+=o.loaded,a+=o.total;const e=f.includes("encoder")?"Enc":f.includes("decoder")?"Dec":"File",M=c(o.loaded),w=c(o.total);if(o.total>0){const _=Math.round(o.loaded/o.total*100);s.push(`${e}: ${M}/${w} MB (${_}%)`)}else s.push(`${e}: ${M} MB`)}),a===0)return;const h=Math.round(t/a*100);l(`${s.join(" | ")}`,h)};l&&l("Loading models...",0);const p=async t=>{const a=`https://huggingface.co/${r}/resolve/main/${t}`;await d.downloadFile(a,s=>{n[t]={loaded:s.loaded,total:s.total},u()})};await Promise.all(m.map(t=>p(t)))}async loadModelWithFallback(r,i,l){var n,c,u,p,t,a,s,h,f;const d=i,m=F(d);try{return{model:await S.from_pretrained(r,m),device:d}}catch(o){const e=o,M=((n=e==null?void 0:e.message)==null?void 0:n.includes("createBuffer"))||((c=e==null?void 0:e.message)==null?void 0:c.includes("mappedAtCreation"))||((u=e==null?void 0:e.message)==null?void 0:u.includes("too large for the implementation"))||((p=e==null?void 0:e.message)==null?void 0:p.includes("GPUDevice")),w=(t=e==null?void 0:e.message)==null?void 0:t.includes("Unsupported device"),_=((a=e==null?void 0:e.message)==null?void 0:a.includes("Failed to create the session"))||((s=e==null?void 0:e.message)==null?void 0:s.includes("Validation Error"))||((h=e==null?void 0:e.message)==null?void 0:h.includes("context"))||((f=e==null?void 0:e.message)==null?void 0:f.includes("adapter"));if((M||w||_)&&d===$.PROVIDERS.WEBGPU){console.warn("[ModelLoader] WebGPU error encountered, falling back to WASM:",e.message);const U=F($.PROVIDERS.WASM);return{model:await S.from_pretrained(r,U),device:$.PROVIDERS.WASM}}else throw e}}async validateModelFiles(r,i){const{downloadManager:l}=await import("./DownloadManager-CzsYuBUX.js"),d=[`onnx/${i.encoder_model_file_name}`,`onnx/${i.decoder_model_file_name}`],m=[];for(const n of d){const c=`https://huggingface.co/${r}/resolve/main/${n}`,u=n.split("/").pop(),p=$.CHECKSUMS[u];try{const t=await l.checkCacheIntegrity(c,p);t.ok||(console.warn(`[ModelLoader] File ${t.missing?"missing":"corrupted"}: ${n}${t.reason?` - ${t.reason}`:""}`),m.push(c))}catch(t){console.error(`[ModelLoader] Failed to check integrity for ${n}:`,t)}}return m}}const D=g.getInstance();export{g as ModelLoader,D as modelLoader};
