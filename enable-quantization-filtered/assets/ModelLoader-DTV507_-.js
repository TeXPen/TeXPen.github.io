const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DownloadManager-DqPg6hV1.js","./transformers.web-Bd_UkAim.js"])))=>i.map(i=>d[i]);
import{_ as S,M}from"./index-B6KwwXlv.js";import{a as F}from"./transformers.web-Bd_UkAim.js";import{getSessionOptions as v}from"./index-CHc1z7rp.js";class g{constructor(){}static getInstance(){return g.instance||(g.instance=new g),g.instance}async preDownloadModels(m,i,l){const{downloadManager:d}=await S(async()=>{const{downloadManager:t}=await import("./DownloadManager-DqPg6hV1.js");return{downloadManager:t}},__vite__mapDeps([0,1]),import.meta.url),r=[`onnx/${i.encoder_model_file_name}`,`onnx/${i.decoder_model_file_name}`],n={};r.forEach(t=>{n[t]={loaded:0,total:0}});const a=t=>(t/1024/1024).toFixed(2),u=()=>{if(!l)return;let t=0,c=0;const s=[];if(Object.entries(n).forEach(([_,o])=>{t+=o.loaded,c+=o.total;const e=_.includes("encoder")?"Enc":_.includes("decoder")?"Dec":"File",w=a(o.loaded),h=a(o.total);if(o.total>0){const $=Math.round(o.loaded/o.total*100);s.push(`${e}: ${w}/${h} MB (${$}%)`)}else s.push(`${e}: ${w} MB`)}),c===0)return;const f=Math.round(t/c*100);l(`${s.join(" | ")}`,f)};l&&l("Loading models...",0);const p=async t=>{const c=`https://huggingface.co/${m}/resolve/main/${t}`;await d.downloadFile(c,s=>{n[t]={loaded:s.loaded,total:s.total},u()})};await Promise.all(r.map(t=>p(t)))}async loadModelWithFallback(m,i,l){var n,a,u,p,t,c,s,f,_;const d=i,r=v(d);try{return{model:await F.from_pretrained(m,r),device:d}}catch(o){const e=o,w=((n=e==null?void 0:e.message)==null?void 0:n.includes("createBuffer"))||((a=e==null?void 0:e.message)==null?void 0:a.includes("mappedAtCreation"))||((u=e==null?void 0:e.message)==null?void 0:u.includes("too large for the implementation"))||((p=e==null?void 0:e.message)==null?void 0:p.includes("GPUDevice")),h=(t=e==null?void 0:e.message)==null?void 0:t.includes("Unsupported device"),$=((c=e==null?void 0:e.message)==null?void 0:c.includes("Failed to create the session"))||((s=e==null?void 0:e.message)==null?void 0:s.includes("Validation Error"))||((f=e==null?void 0:e.message)==null?void 0:f.includes("context"))||((_=e==null?void 0:e.message)==null?void 0:_.includes("adapter"));if((w||h||$)&&d===M.PROVIDERS.WEBGPU){console.warn("[ModelLoader] WebGPU error encountered, falling back to WASM:",e.message);const y=v(M.PROVIDERS.WASM);return{model:await F.from_pretrained(m,y),device:M.PROVIDERS.WASM}}else throw e}}async validateModelFiles(m,i){const{downloadManager:l}=await S(async()=>{const{downloadManager:n}=await import("./DownloadManager-DqPg6hV1.js");return{downloadManager:n}},__vite__mapDeps([0,1]),import.meta.url),d=[`onnx/${i.encoder_model_file_name}`,`onnx/${i.decoder_model_file_name}`],r=[];for(const n of d){const a=`https://huggingface.co/${m}/resolve/main/${n}`,u=n.split("/").pop(),p=M.CHECKSUMS[u];try{const t=await l.checkCacheIntegrity(a,p);t.ok||(console.warn(`[ModelLoader] File ${t.missing?"missing":"corrupted"}: ${n}${t.reason?` - ${t.reason}`:""}`),r.push(a))}catch(t){console.error(`[ModelLoader] Failed to check integrity for ${n}:`,t)}}return r}}const O=g.getInstance();export{g as ModelLoader,O as modelLoader};
